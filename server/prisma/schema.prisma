generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String                   @id @default(cuid())
  username         String                   @unique
  email            String                   @unique
  password         String?
  nickname         String?
  avatar           String?
  avatarKey        String?
  role             String                   @default("user")
  isActive         Boolean                  @default(true)
  lastLogin        DateTime?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  invitedBy        String?
  inviteCodeUsed   String?
  inviteVerified   Boolean                  @default(false)
  conversations    AIConversation[]
  batchGenerations BatchChapterGeneration[]
  files            File[]
  createdInvites   InviteCode[]             @relation("CreatedInvites")
  inviteUsages     InviteUsage[]
  memoryBackups    MemoryBackup[]
  novels           Novel[]
  inviter          User?                    @relation("UserInvites", fields: [invitedBy], references: [id])
  invitees         User[]                   @relation("UserInvites")
  aiPreferences    UserAIPreferences?
  sessions         UserSession[]
  socialAccounts   SocialAccount[]
}

model Novel {
  id               String                   @id @default(cuid())
  userId           String
  title            String
  description      String?
  genre            String?
  rating           String                   @default("PG")
  status           String                   @default("draft")
  wordCount        Int                      @default(0)
  targetWordCount  Int?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  aiSettings       AIConstraint?
  conversations    AIConversation[]
  batchGenerations BatchChapterGeneration[]
  chapters         Chapter[]
  characters       Character[]
  files            File[]
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  statistics       NovelStatistics[]
  workflows        WorkflowConfig[]
  settings         WorldSetting[]
  goals            WritingGoal[]

  @@index([userId])
}

model Character {
  id                      String             @id @default(cuid())
  novelId                 String
  name                    String
  description             String?
  age                     String?
  gender                  String?
  identity                String?
  appearance              String?
  personality             String?
  values                  String?
  fears                   String?
  background              String?
  skills                  String?
  relationships           String?
  avatar                  String?
  avatarKey               String?
  avatarMetadata          String?
  isLocked                Boolean            @default(false)
  firstMessage            String?
  messageExample          String?
  alternateGreetings      String?
  systemPrompt            String?
  postHistoryInstructions String?
  tags                    String?
  creator                 String?
  characterVersion        String?
  characterBook           String?
  originalCardData        String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  chapterRefs             ChapterCharacter[]
  novel                   Novel              @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@index([novelId])
}

model WorldSetting {
  id          String           @id @default(cuid())
  novelId     String
  type        String
  name        String
  description String
  details     String?
  isLocked    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  chapterRefs ChapterSetting[]
  novel       Novel            @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@index([novelId])
}

model Chapter {
  id              String             @id @default(cuid())
  novelId         String
  chapterNumber   Int
  title           String
  outline         String?
  content         String?
  plotPoints      String?
  illustrations   String?
  status          String             @default("planning")
  wordCount       Int                @default(0)
  targetWordCount Int?
  progress        Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  novel           Novel              @relation(fields: [novelId], references: [id], onDelete: Cascade)
  characters      ChapterCharacter[]
  settings        ChapterSetting[]
  consistencyLog  ConsistencyCheck[]

  @@unique([novelId, chapterNumber])
  @@index([novelId])
}

model AIConstraint {
  id          String   @id @default(cuid())
  novelId     String   @unique
  rating      String   @default("PG")
  violence    Int      @default(2)
  romance     Int      @default(1)
  language    Int      @default(1)
  customRules String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
}

model ConsistencyCheck {
  id        String   @id @default(cuid())
  chapterId String
  type      String
  issue     String
  severity  String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
}

model ChapterCharacter {
  chapterId   String
  characterId String
  role        String?
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  chapter     Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@id([chapterId, characterId])
}

model ChapterSetting {
  chapterId String
  settingId String
  usage     String?
  setting   WorldSetting @relation(fields: [settingId], references: [id], onDelete: Cascade)
  chapter   Chapter      @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@id([chapterId, settingId])
}

model NovelStatistics {
  id        String   @id @default(cuid())
  novelId   String
  date      DateTime
  wordCount Int      @default(0)
  timeSpent Int      @default(0)
  createdAt DateTime @default(now())
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@unique([novelId, date])
  @@index([novelId])
}

model WritingGoal {
  id        String   @id @default(cuid())
  novelId   String
  type      String
  target    Int
  period    String
  achieved  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@unique([novelId, type, period])
  @@index([novelId])
}

model StatusHistory {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  fromStatus  String?
  toStatus    String
  triggeredBy String
  reason      String?
  metadata    String?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model WorkflowConfig {
  id          String   @id @default(cuid())
  novelId     String
  entityType  String
  transitions String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)

  @@unique([novelId, entityType])
  @@index([novelId])
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastUsed     DateTime @default(now())
  userAgent    String?
  ipAddress    String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model AIConversation {
  id        String      @id @default(cuid())
  userId    String
  novelId   String?
  mode      String      @default("chat")
  title     String
  settings  String?
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  novel     Novel?      @relation(fields: [novelId], references: [id])
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AIMessage[]

  @@index([userId])
  @@index([novelId])
  @@index([userId, updatedAt])
}

model AIMessage {
  id             String         @id @default(cuid())
  conversationId String
  role           String
  content        String
  messageType    String?
  metadata       String?
  actions        String?
  createdAt      DateTime       @default(now())
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, createdAt])
}

model InviteCode {
  id          String        @id @default(cuid())
  code        String        @unique
  createdBy   String?
  maxUses     Int           @default(1)
  usedCount   Int           @default(0)
  expiresAt   DateTime?
  isActive    Boolean       @default(true)
  description String?
  codeType    String        @default("user")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  creator     User?         @relation("CreatedInvites", fields: [createdBy], references: [id])
  usages      InviteUsage[]

  @@index([code])
  @@index([createdBy])
  @@index([isActive, expiresAt])
}

model InviteUsage {
  id         String     @id @default(cuid())
  codeId     String
  userId     String
  usedAt     DateTime   @default(now())
  ipAddress  String?
  userAgent  String?
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviteCode InviteCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  @@unique([codeId, userId])
  @@index([codeId])
  @@index([userId])
}

model MemoryBackup {
  id         String   @id @default(cuid())
  userId     String
  novelId    String?
  mem0Id     String?
  content    String
  memoryType String   @default("general")
  importance Int      @default(1)
  metadata   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([novelId])
  @@index([memoryType])
  @@index([userId, novelId])
  @@index([importance])
}

model BatchChapterGeneration {
  id                String             @id @default(cuid())
  novelId           String
  userId            String
  batchName         String
  mode              String
  parameters        String
  status            String             @default("pending")
  progress          Int                @default(0)
  totalChapters     Int
  completedChapters Int                @default(0)
  startPosition     Int?
  analysisResult    String?
  errorMessage      String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  novel             Novel              @relation(fields: [novelId], references: [id], onDelete: Cascade)
  generatedChapters GeneratedChapter[]

  @@index([novelId])
  @@index([userId])
  @@index([status])
}

model GeneratedChapter {
  id             String                 @id @default(cuid())
  batchId        String
  chapterNumber  Int
  title          String
  outline        String
  plotPoints     String
  characters     String?
  settings       String?
  estimatedWords Int                    @default(0)
  priority       Int                    @default(1)
  dependencies   String?
  aiConfidence   Float                  @default(0.8)
  status         String                 @default("draft")
  notes          String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  batch          BatchChapterGeneration @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@unique([batchId, chapterNumber])
  @@index([batchId])
  @@index([status])
}

model UserAIPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  preferredProvider String?
  preferredModel    String?
  taskPreferences   String   @default("{}")
  autoSave          Boolean  @default(true)
  maxHistoryLength  Int      @default(50)
  customConfigs     String   @default("[]")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model File {
  id          String   @id @default(cuid())
  userId      String
  novelId     String?
  fileName    String
  fileKey     String
  fileUrl     String
  fileType    String
  fileSize    Int
  category    String   @default("other")
  description String?
  tags        String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  novel       Novel?   @relation(fields: [novelId], references: [id])
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([novelId])
  @@index([category])
  @@index([createdAt])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model SocialAccount {
  id               String    @id @default(cuid())
  userId           String
  provider         String
  providerId       String
  providerUsername String?
  providerEmail    String?
  displayName      String?
  avatar           String?
  profileUrl       String?
  accessToken      String?   @db.Text
  refreshToken     String?   @db.Text
  tokenType        String?
  expiresAt        DateTime?
  scopes           String?
  rawData          Json?
  lastUsed         DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider, providerEmail])
}
